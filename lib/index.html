<!doctype html>
<html>
<head>
  <!-- TODO: get rid of angular and bootstrap
    also maybe just SSR this
  -->
  <title>GWN</title>
  <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/css/bootstrap.min.css" rel="stylesheet">
  <style type="text/css">
    .innerTable {
      margin-top: 1em;
    }
    .sourcehead {
      background-color: white;
      position: fixed;
      left: 4em;
      top: 4em;
      right: 4em;
      bottom: 4em;
      z-index: 2;
      -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
      -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
      box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
      -webkit-border-radius: 0.5em;
      -moz-border-radius: 0.5em;
      border-radius: 0.5em;
    }

    .sourcehead table {
      border-bottom: 1px gray solid;
      border-top-color: white;
      color: #999922;
      width: 100%;
    }

    .sourcehead table tr td {
      border: none;
      vertical-align: middle;
      text-align: left;
    }

    .sourcefade {
      position: fixed;
      left: 0em;
      top: 0em;
      right: 0em;
      bottom: 0em;
      z-index: 1;
      background-color: rgba(100,100,50, 0.5);
    }

    .sourcepopup {
      overflow: auto;
      position: fixed;
      top: 14em;
      bottom: 4em;
      left: 4em;
      right: 4em;
      background-color: white;
      border: none;
      margin-left: 1em;
      margin-right: 1em;
    }

    .table-striped>tbody>tr:nth-child(odd)>th  {
      background-color: rgba(20, 20, 20, 0.05);
    }
    .table-striped>tbody>tr:nth-child(odd)>td  {
      background-color: rgba(20, 20, 20, 0.05);
    }
    .well {
      background-color: rgba(255, 255, 255, 0.25);
    }
  </style>
</head>
<body ng-app="gittattle">
  <div class="main">
    <div class="container-fluid" ng-controller="Ctrllr">
      <div class="row-fluid"><h1 class="span12">GitWeb Node</h1></div>
      <div class="row-fluid">
        <div class="span12">
          <table class="table table-striped" ng-controller="FilesAndCommits">
            <tr ng-repeat="repo in repos">
              <th class="span1" ng-click="toggle(repo)" stop-event="click">{{repo.name}}</th>
              <th class="span4" ng-click="toggle(repo)" stop-event="click">{{repo.description}}</th>
              <td class="span1" ng-click="toggle(repo)" ng-show="!repo.expanded" stop-event="click">{{repo.lastCommit.author}}</td>
              <td class="span3" ng-click="toggle(repo)" ng-show="!repo.expanded" stop-event="click">{{repo.lastCommit.message}}</td>
              <td ng-show="!repo.expanded">{{repo.lastCommit.age}}</td>
              <td ng-show="repo.expanded" colspan="3" class="well">
                <ul class="nav nav-tabs">
                  <li ng-class="{ 'active' : commitTabActive}" ng-click="commitsSelected()" stop-event="click">
                    <a href="#">Commits <span class="badge" ng-show="commits && commits.length > 1">{{commits.length}}</span></a>
                  </li>
                  <li ng-class="{ 'active' : !commitTabActive}" ng-click="filesSelected()" stop-event="click">
                    <a href="#">Files <span class="badge" ng-show="files && files.length > 1">{{files.length}}</span></a>
                  </li>
                </ul>
                <table class="innerTable" ng-show="commitTabActive">
                  <tbody>
                    <tr ng-repeat="commit in commits">
                      <th>{{commit.author}}</th>
                      <td ng-click="contentVisible = !contentVisible" stop-event="click">{{commit.message}}</td>
                      <td>{{commit.age}}</td>
                      <td>{{commit.date| date}}</td>
                      <td ng-show="contentVisible">
                        <div class="sourcefade" ng-click="contentVisible = false" stop-event="click">
                          <div class="sourcehead" ng-click="contentVisible = true" stop-event="click">
                            <table>
                              <tr>
                                <td><h1>{{repo.name}} {{commit.hash}}</h1><i>{{commit.author}}, {{commit.date| date}}</i></td>
                                <td><button class="btn btn-primary pull-right" ng-click="contentVisible = false" stop-event="click">Close</button></td>
                              </tr>
                            </table>
                            <pre class="sourcepopup" source="{{commit.hash}}" repo="{{repo.id}}">...loading...</pre>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <table class="innerTable" ng-hide="commitTabActive">
                  <tbody>
                    <tr ng-repeat="file in files">
                      <td>{{file.type}}</td>
                      <th ng-click="contentVisible = !contentVisible" stop-event="click">{{file.path}}</th>
                      <td>{{file.length}}</td>
                      <td><a href="/api/{{repo.id}}/get/{{file.path}}?raw=true" target="dl">Raw</a></td>
                      <td ng-show="contentVisible">
                        <div class="sourcefade" ng-click="contentVisible = false" stop-event="click">
                          <div class="sourcehead" ng-click="contentVisible = true" stop-event="click">
                            <table>
                              <tr>
                                <td><h1>{{repo.name}} {{file.path}}</h1><i></i></td>
                                <td><button class="btn btn-primary pull-right" ng-click="contentVisible = false" stop-event="click">Close</button></td>
                              </tr>
                            </table>
                            <pre ng-show="contentVisible && files" class="sourcepopup" source="true" path="{{file.path}}" repo="{{repo.id}}">...loading...</pre>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </td>
              <td>
                <a href="/api/{{repo.id}}.zip">zip</a>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular.min.js"></script>
  <script type="text/javascript">
var app = angular.module('gittattle', []);
app.directive('stopEvent', function () {
  return {
    restrict: 'A',
    link: function (scope, element, attr) {
      element.bind(attr.stopEvent, (e) => {
        e.preventDefault()
      })
    }
  }
})

app.directive('source', function ($http) {
  return {
    replace: true,
    restrict: 'A',
    scope: false,
    link: function (scope, iElement, iAttrs) {
      var out = angular.element('<pre class="sourcepopup"></pre>')
      iElement.parent().append(out)
      iElement.css('display', 'none')
      var content = '...loading ' + iAttrs.repo + " " + (iAttrs.path ? iAttrs.path : iAttrs.source) + "..."
      var orig = content

      function url () {
        if (iAttrs.path) {
          return '/api/' + iAttrs.repo + '/get/' + iAttrs.path
        } else {
          return '/api/' + iAttrs.repo + '/' + iAttrs.source
        }
      }

      out.css('display', 'none')
      out.text(content)
      scope.$watch('contentVisible', () => {
        if (scope.contentVisible) {
          out.css('display', 'block')
          if (content === orig) {
            $http.get(url()).success((data) => {
              if (typeof data === 'object') {
                data = JSON.stringify(data)
              }
              content = data
              iElement.parent().append(out)
              out.text(data)
            }).error((err) => {
              out.text(err)
            })
          }
        } else {
          out.css('display', 'none')
          out.text(content)
        }
      })
    }
  }
})

function Ctrllr ($scope, $http) {
  $http.get('/api/list').success((dta) => {
    if (typeof dta['forEach'] === 'function') {
      dta.forEach((repo) => {
        repo.expanded = false
      })
      $scope.repos = dta
    } else {
      console.error(dta)
    }
  }).error((err, status) => {
    console.error(err || status)
  })
}

var dummyCommit = {
  hash: '',
  author: '',
  date: new Date(),
  message: '...loading commit list...',
  path: '...loading file list...'
}

function FilesAndCommits ($scope, $http) {
  $scope.commitTabActive = true
  $scope.commmits = [dummyCommit]
  $scope.files = [dummyCommit]

  $scope.commitsSelected = () => {
    $scope.commitTabActive = true
    loadCommits()
  }

  $scope.filesSelected = () => {
    $scope.commitTabActive = false
    loadFiles()
  }

  $scope.toggle = (repo) => {
    $scope.commits = [dummyCommit]
    $scope.files = [dummyCommit]
    $scope.repo = repo
    $scope.repos.forEach((r) => {
      if (r !== repo) {
        r.expanded = false
      }
    })
    repo.expanded = !repo.expanded
    $scope.commitTabActive = true
    loadCommits()
  }

  function needLoad (arr) {
    if (typeof arr !== 'undefined' && typeof arr !== 'undefined') {
      if (arr.length === 0) return true
      if (arr.length === 1) return arr[0] === dummyCommit
    } else {
      return true
    }
    return false
  }

  function loadCommits () {
    if (needLoad($scope.commits)) {
      $scope.commits = [dummyCommit]

      $http.get('/api/' + $scope.repo.id).success((log) => {
        log.forEach((cmt) => {
          if (typeof cmt.date === 'string') {
            cmt.date = new Date(Date.parse(cmt.date))
          }
        })
        $scope.commits = log
      }).error((err, status) => {
        console.error(err || status)
      })
    }
  }

  function loadFiles () {
    if (needLoad($scope.files)) {
      $http.get('/api/' + $scope.repo.id + '/list').success((files) => {
        $scope.files = files
      }).error((err, status) => {
        console.error(err || status)
      })
    }
  }
}
  </script>
</body>
</html>
